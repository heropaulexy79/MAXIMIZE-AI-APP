// Results Page Logic — Only Show Make AI Output

class ResultsPage {
  constructor() {
    this.data = null;
    this.init();
  }

  init() {
    this.loadResultData();
  }

  loadResultData() {
    const stored = localStorage.getItem('maximizeResult');

    if (!stored) {
      this.showError();
      return;
    }

    try {
      this.data = JSON.parse(stored);
      this.displayResults();
    } catch (error) {
      console.error('Error parsing result data:', error);
      this.showError();
    }
  }

  displayResults() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsState').style.display = 'block';

    this.displayAIOutput();
    this.setupButtons();
  }

 displayAIOutput() {
  const ai = this.data.ai;
  if (!ai) return;

  // Stage
  const stageName = ai.stage || 'Unknown Stage';
  document.getElementById('stageName').textContent = stageName;
  document.getElementById('stageDescription').textContent = ai.core_issue || '';

  // Recommendations / Next Actions
  let nextActions = ai.next_action;

  // Ensure it's an array
  if (!Array.isArray(nextActions)) {
    nextActions = String(nextActions).split(',').map(item => item.trim());
  }

  const container = document.getElementById('recommendationsContainer');
  container.innerHTML = nextActions
    .map((action, index) => `
      <div class="recommendation-item">
        <div class="recommendation-title">${index + 1}. Action Step</div>
        <p class="recommendation-text">${action}</p>
      </div>
    `)
    .join('');

  // Reflection Question
  if (ai.reflection_question) {
    container.innerHTML += `
      <div class="recommendation-item">
        <div class="recommendation-title">Reflection Question</div>
        <p class="recommendation-text">${ai.reflection_question}</p>
      </div>
    `;
  }
}


  setupButtons() {
    document.getElementById('downloadBtn').addEventListener('click', () => {
      this.downloadReport();
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      localStorage.removeItem('maximizeResult');
      window.location.href = 'assessment.html';
    });
  }

  downloadReport() {
    const aiData = this.data.ai;
    if (!aiData) return;

    const stage = aiData.stage || '';
    const coreIssue = aiData.core_issue || '';
    const nextActions = aiData.next_action || [];
    const reflectionQuestion = aiData.reflection_question || '';

    const reportContent = `
MAXIMIZE — PERSONAL INSIGHT REPORT
════════════════════════════════════

STAGE:
${stage}

CORE ISSUE:
${coreIssue}

NEXT ACTIONS:
${nextActions.map((a, i) => `${i + 1}. ${a}`).join('\n')}

REFLECTION QUESTION:
${reflectionQuestion}

════════════════════════════════════
Generated by MAXIMIZE AI Diagnostic
    `.trim();

    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(reportContent));
    element.setAttribute('download', 'MAXIMIZE_Insight_Report.txt');
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  showError() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  new ResultsPage();
});
