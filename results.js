// Results Page Logic — Updated for Make JSON

class ResultsPage {
  constructor() {
    this.data = null;
    this.init();
  }

  init() {
    this.loadResultData();
  }

  loadResultData() {
    const stored = localStorage.getItem('maximizeResult');

    if (!stored) {
      this.showError();
      return;
    }

    try {
      this.data = JSON.parse(stored);
      this.displayResults();
    } catch (error) {
      console.error('Error parsing result data:', error);
      this.showError();
    }
  }

  displayResults() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsState').style.display = 'block';

    this.displayStage();
    this.displayInsights();
    this.displayRecommendations();
    this.setupButtons();
  }

  displayStage() {
    // Use AI stage if available, fallback to assessment
    const stage = this.data.ai?.stage || this.data.assessment?.stage || 'Unknown Stage';

    document.getElementById('stageName').textContent = stage;
    document.getElementById('stageDescription').textContent =
      this.getStageDescription(stage);
  }

  displayInsights() {
    const answers = this.data.assessment?.answers;
    const aiData = this.data.ai;

    if (!answers) return;

    document.getElementById('insightRole').textContent = answers.role || 'Not specified';

    const challengesList = answers.challenges || [];
    document.getElementById('insightChallenges').innerHTML =
      challengesList.map(c => `<span class="challenge-tag">${c}</span>`).join('') || 'Not specified';

    document.getElementById('insightStuck').textContent = `"${answers.stuck || 'Not specified'}"`;

    document.getElementById('insightPosture').textContent = answers['growth-posture'] || 'Not specified';
  }

  displayRecommendations() {
    const aiData = this.data.ai;
    const container = document.getElementById('recommendationsContainer');

    if (!aiData) {
      container.innerHTML = '<p>No recommendations available.</p>';
      return;
    }

    // AI next actions from Make JSON
    const nextActions = aiData.next_action || [];
    const reflectionQuestion = aiData.reflection_question || '';

    container.innerHTML = '';

    if (nextActions.length > 0) {
      nextActions.forEach((action, index) => {
        container.innerHTML += `
          <div class="recommendation-item">
            <div class="recommendation-title">${index + 1}. Action Step</div>
            <p class="recommendation-text">${action}</p>
          </div>
        `;
      });
    }

    // Add reflection question at the end
    if (reflectionQuestion) {
      container.innerHTML += `
        <div class="recommendation-item">
          <div class="recommendation-title">Reflection Question</div>
          <p class="recommendation-text">${reflectionQuestion}</p>
        </div>
      `;
    }
  }

  getStageDescription(stage) {
    const descriptions = {
      'Identity Revelation':
        'This stage is about uncovering who you truly are beneath performance and pressure.',
      'Mindset Transformation':
        'Here, you are rewiring the internal architecture shaping your decisions.',
      'Leadership Activation':
        'You are stepping into influence and activating responsibility.',
      'Purpose Deployment':
        'Execution becomes aligned with purpose and structure.',
      'Legacy Construction':
        'You are thinking beyond impact toward generational influence.'
    };

    return descriptions[stage] || 'Continue your growth journey with clarity and intention.';
  }

  setupButtons() {
    document.getElementById('downloadBtn').addEventListener('click', () => {
      this.downloadReport();
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      localStorage.removeItem('maximizeResult');
      window.location.href = 'assessment.html';
    });
  }

  downloadReport() {
    const answers = this.data.assessment?.answers;
    const aiData = this.data.ai;

    const stage = aiData?.stage || this.data.assessment?.stage;
    const coreInsight = aiData?.core_issue || '';
    const nextActions = aiData?.next_action || [];
    const reflectionQuestion = aiData?.reflection_question || '';

    const reportContent = `
MAXIMIZE — PERSONAL INSIGHT REPORT
════════════════════════════════════

STAGE:
${stage}

CORE INSIGHT:
${coreInsight}

NEXT ACTIONS:
${nextActions.map((a, i) => `${i + 1}. ${a}`).join('\n')}

REFLECTION QUESTION:
${reflectionQuestion}

ROLE:
${answers?.role || 'Not specified'}

CHALLENGES:
${answers?.challenges?.join('\n') || 'Not specified'}

WHAT FEELS STUCK:
"${answers?.stuck || 'Not specified'}"

GROWTH POSTURE:
${answers?.['growth-posture'] || 'Not specified'}

════════════════════════════════════
Generated by MAXIMIZE AI Diagnostic
    `.trim();

    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(reportContent));
    element.setAttribute('download', 'MAXIMIZE_Insight_Report.txt');
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  showError() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  new ResultsPage();
});
