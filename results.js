// Results Page Logic — Only Show Make AI Output

class ResultsPage {
  constructor() {
    this.data = null;
    this.init();
  }

  init() {
    this.loadResultData();
  }

  loadResultData() {
    const stored = localStorage.getItem('maximizeResult');

    if (!stored) {
      this.showError();
      return;
    }

    try {
      this.data = JSON.parse(stored);
      this.displayResults();
    } catch (error) {
      console.error('Error parsing result data:', error);
      this.showError();
    }
  }

  displayResults() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsState').style.display = 'block';

    this.displayAIOutput();
    this.setupButtons();
  }

  displayAIOutput() {
    const aiData = this.data.ai;

    if (!aiData) {
      document.getElementById('recommendationsContainer').innerHTML = '<p>No AI data available.</p>';
      return;
    }

    // Stage
    document.getElementById('stageName').textContent = aiData.stage || 'Unknown Stage';

    // Core Issue
    document.getElementById('stageDescription').textContent = aiData.core_issue || '';

    // Next Actions
    const nextActions = aiData.next_action || [];
    const container = document.getElementById('recommendationsContainer');
    container.innerHTML = '';

    nextActions.forEach((action, index) => {
      container.innerHTML += `
        <div class="recommendation-item">
          <div class="recommendation-title">${index + 1}. Next Action</div>
          <p class="recommendation-text">${action}</p>
        </div>
      `;
    });

    // Reflection Question
    if (aiData.reflection_question) {
      container.innerHTML += `
        <div class="recommendation-item">
          <div class="recommendation-title">Reflection Question</div>
          <p class="recommendation-text">${aiData.reflection_question}</p>
        </div>
      `;
    }
  }

  setupButtons() {
    document.getElementById('downloadBtn').addEventListener('click', () => {
      this.downloadReport();
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      localStorage.removeItem('maximizeResult');
      window.location.href = 'assessment.html';
    });
  }

  downloadReport() {
    const aiData = this.data.ai;
    if (!aiData) return;

    const stage = aiData.stage || '';
    const coreIssue = aiData.core_issue || '';
    const nextActions = aiData.next_action || [];
    const reflectionQuestion = aiData.reflection_question || '';

    const reportContent = `
MAXIMIZE — PERSONAL INSIGHT REPORT
════════════════════════════════════

STAGE:
${stage}

CORE ISSUE:
${coreIssue}

NEXT ACTIONS:
${nextActions.map((a, i) => `${i + 1}. ${a}`).join('\n')}

REFLECTION QUESTION:
${reflectionQuestion}

════════════════════════════════════
Generated by MAXIMIZE AI Diagnostic
    `.trim();

    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(reportContent));
    element.setAttribute('download', 'MAXIMIZE_Insight_Report.txt');
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  showError() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  new ResultsPage();
});
